<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>WhimsyLove旅途记录-去过的地方和读过的书，构成独一无二的我</title>
  <style>
    *{margin: 0;padding:0;}
    body{
      overflow-x: hidden;
    } 
    #container {width:100vw; height: 100vh; }
    .point-form-container{
      z-index: 999;
      position: fixed;
      right: 0;
      top: 0;
      height: 100vh;
      width: 20vw;
      min-width: 200px;
      background-color: rgba(255,255,255,.6);
      backdrop-filter:  blur(5px);
      transition: all .3s ease;
      transform: translateX(100%);
    } 
    .point-form-container.active{
      transform: translateX(0);
    }
    .point-form{
      display: flex;
      flex-direction: column;
      padding: 10px 20px;
    }  
  </style>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no"> 
  <script src="https://webapi.amap.com/loader.js"></script> 
  <script src="./static/fetch.js"></script> 
</head>
<body>
  <div id="container"></div>
  <div class="point-form-container" id="point-form-container">
    <form class="point-form" id="point-form">
      <label for="">地点名称</label>
      <input type="text" name="title">
      <label for="">备注</label>
      <textarea rows="4" name="remark"></textarea> 
      <label for="">详细地址</label>
      <input type="text" name="address">
      <label for="">去的时间</label>
      <input type="text" name="dateTime">

      <button type="button" id="point-form-submit">提交</button>
    </form>
  </div>
  <script>
    let pointFormSubmit = document.querySelector("#point-form-submit")
    pointFormSubmit.addEventListener("click",(e)=>{

      let form = document.getElementById("point-form"),
          formData = new FormData(form),
          params = {
            lnglat:contextMenuPositon
          }
      formData.forEach((v,k)=>{
        params[k] = v
      })
      ajax({
        url:"/points",
        method:"POST",
        headers:{
          "Content-Type":"application/json"
        },
        body: JSON.stringify(params)
      })
    })
  </script>
  <script>
    //contextMenuPositon 全局变量，右键点击的位置和地址
    //contextMenuAddress
    AMapLoader.load({
        "key": "42b77b78693257d472dc3c70311c3b1f",              // 申请好的Web端开发者Key，首次调用 load 时必填
        "version": "2.0",   // 指定要加载的 JSAPI 的版本，缺省时默认为 1.4.15
        "plugins": ["AMap.MarkerCluster","AMap.MouseTool","AMap.Geocoder"]           // 需要使用的的插件列表，如比例尺'AMap.Scale'等
    }).then((AMap)=>{
      window.AMap = AMap
      ajax({
        url:'/points'
      })
      .then(function(result) {
        console.log(result);
        if(result.status==1){
          initMap(AMap,result.data.points)
        }
      })
    }).catch((e)=>{
        console.error(e);  //加载错误提示
    });   

    const initMap = (AMap,interestPoints)=>{
      var map = new AMap.Map('container', {
          zoom:11,//级别
          zooms:[4,14],
          doubleClickZoom:false,
      })    
      var geocoder = new AMap.Geocoder({
        extensions:"all"
      });        
      //创建地图右键菜单
      var contextMenu = new AMap.ContextMenu();
      var rightContextMenu = new AMap.ContextMenu();

      const markerRightClick = (e)=>{
        rightContextMenu.open(map, e.lnglat);
      }      
      const createMarkerContent = (poi)=>{
        return `<h3>${poi.title}</h3>
        <p>${poi.remark}</p>
        <button type="button" onclick="markerRemoveClick">删除</button>`
      }      
      var markerClick = (e) => {
          pointDetailWindow.setContent(e.target.content);
          pointDetailWindow.open(map, e.target.getPosition());
      }      
      var markerRemoveClick = (e)=>{

      }
      var pointDetailWindow = new AMap.InfoWindow({
        closeWhenClickMap:true,
        offset: new AMap.Pixel(0, -30)
      });
      for (var i = 0, marker; i < interestPoints.length; i++) {
          var marker = new AMap.Marker({
              position: interestPoints[i]['lnglat'],
              map: map
          });
          marker.content = createMarkerContent(interestPoints[i]);
          marker.on('click', markerClick);
          // marker.emit('click', {target: marker});
          marker.on('rightclick',markerRightClick)
      }


      //右键添加Marker标记
      contextMenu.addItem("添加标记", function (e) {
          // var marker = new AMap.Marker({
          //     map: map,
          //     position: contextMenuPositon //基点位置
          // }); 
          // console.log(e)
          document.querySelector("#point-form-container").classList.add("active")
      }, 0);
      //右键添加Marker标记
      rightContextMenu.addItem("移除标记", function (e) {
        // console.log(e)      
      }, 0);      

      //地图绑定鼠标右击事件——弹出右键菜单
      map.on('rightclick', function (e) {
          contextMenu.open(map, e.lnglat);
          contextMenuPositon = e.lnglat;
          geocoder.getAddress(contextMenuPositon, function(status, result) {
            if (status === 'complete'&&result.regeocode) {
              console.log(result)
                var address = result.regeocode.formattedAddress;
                contextMenuAddress = address
                document.querySelector("input[name='address']").value = address
            }else{
                log.error('根据经纬度查询地址失败')
            }
          });          

      });       


      map.setFitView();
    }
  </script>
</body>
</html>