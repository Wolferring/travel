<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>旅途记录-去过的地方和读过的书，构成独一无二的我.Via Whimsy</title>
  <link rel="shortcut icon" href="./favicon.ico">
  <meta name="viewport" content="user-scalable=no">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <link href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="./static/style.css">
  <script src="https://webapi.amap.com/loader.js"></script> 
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="./static/fetch.js"></script> 
  <script src="./static/util.js"></script> 
  <script src="./static/upload.js"></script> 
</head>
<body>
  <div id="map-container"></div>
  <div id="user-widget-container">
    <div id="statistic" class="user-widget-item"></div>
    <div id="memory-widget" class="user-widget-item"></div>
  </div>
  <div id="public-widget-container">
    <div class="public-widget-item" id="map-control-fullview">
      <span><svg t="1608380140389" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1774" width="20" height="20"><path d="M725.333333 42.666667l128 0q52.992 0 90.496 37.504t37.504 90.496l0 128q0 17.664-12.501333 30.165333t-30.165333 12.501333-30.165333-12.501333-12.501333-30.165333l0-128q0-17.664-12.501333-30.165333t-30.165333-12.501333l-128 0q-17.664 0-30.165333-12.501333t-12.501333-30.165333 12.501333-30.165333 30.165333-12.501333zM85.333333 682.666667q17.664 0 30.165333 12.501333t12.501333 30.165333l0 128q0 17.664 12.501333 30.165333t30.165333 12.501333l128 0q17.664 0 30.165333 12.501333t12.501333 30.165333-12.501333 30.165333-30.165333 12.501333l-128 0q-52.992 0-90.496-37.504t-37.504-90.496l0-128q0-17.664 12.501333-30.165333t30.165333-12.501333zM170.666667 42.666667l128 0q17.664 0 30.165333 12.501333t12.501333 30.165333-12.501333 30.165333-30.165333 12.501333l-128 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333l0 128q0 17.664-12.501333 30.165333t-30.165333 12.501333-30.165333-12.501333-12.501333-30.165333l0-128q0-52.992 37.504-90.496t90.496-37.504zM938.666667 682.666667q17.664 0 30.165333 12.501333t12.501333 30.165333l0 128q0 52.992-37.504 90.496t-90.496 37.504l-128 0q-17.664 0-30.165333-12.501333t-12.501333-30.165333 12.501333-30.165333 30.165333-12.501333l128 0q17.664 0 30.165333-12.501333t12.501333-30.165333l0-128q0-17.664 12.501333-30.165333t30.165333-12.501333z" p-id="1775" fill="#999"></path></svg></span>
    </div>
    <div class="public-widget-item" id="map-control-location">
      <span><svg t="1608390486951" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2612" width="20" height="20"><path d="M87.424 469.312A426.816 426.816 0 0 1 469.312 87.424V0h85.376v87.424a426.816 426.816 0 0 1 381.888 381.888H1024v85.376h-87.424a426.816 426.816 0 0 1-381.888 381.888V1024h-85.376v-87.424A426.816 426.816 0 0 1 87.424 554.688H0v-85.376h87.424z m424.576 384a341.312 341.312 0 1 0 0-682.624 341.312 341.312 0 0 0 0 682.624z m0-170.624a170.688 170.688 0 1 0 0-341.376 170.688 170.688 0 0 0 0 341.376z" fill="#999" p-id="2613"></path></svg></span>
    </div>    
  </div>
  <div id="login-form-container">
    <form class="form" id="login-form">
      <div class="form-heading flex-column">
        <h3>途纪</h3>
        <p>去过的地方和读过的书，构成独一无二的你</p>
      </div>      
      <div class="form-group">
        <label>用户名</label>
        <input autocomplete required="required" class="form-control" type="text" name="username">
      </div>
      <div class="form-group">

        <label>密码</label>
        <input autocomplete required="required" type="password" class="form-control"  name="password" /> 
      </div>  
     <div class="form-group">
        <button type="button" class="button" id="login-form-submit">登录</button>
      </div> 
     <div class="form-group flex">
        <small>还没有账号？</small>
        <a href="javascript:void(0);"  onclick="USER.switch()"><small>免费注册</small></a>

      </div>                
    </form>
    <form class="form" id="register-form">
      <div class="form-heading flex-column">
        <h3>途纪</h3>
        <p>去过的地方和读过的书，构成独一无二的你</p>
      </div>      
      <div class="form-group">
        <label>登录用户名</label>
        <input autocomplete required="required" class="form-control" type="text" name="username">
      </div>
      <div class="form-group">
        <label>显示名称</label>
        <input autocomplete required="required" class="form-control" type="text" name="nickname">
      </div>      
      <div class="form-group">

        <label>密码</label>
        <input required="required" type="password" class="form-control"  name="password" /> 
      </div> 
      <div class="form-group">

        <label>确认密码</label>
        <input required="required" type="password" class="form-control" /> 
      </div>        
     <div class="form-group">
        <button type="button" class="button" id="register-form-submit">注册</button>
      </div> 
     <div class="form-group flex">
        <small>已有账号？</small>
        <a href="javascript:void(0);" onclick="USER.switch()"><small>立即登录</small></a>
      </div>                
    </form>    
  </div>
  <div class="point-form-container" id="point-form-container">
    <form class="point-form" id="point-form">
      <div class="form-heading">
        <h3>创建足迹</h3>
        <button class="button" onclick="FORM.close()" type="button">取消</button>
      </div>
      <div class="form-group">
        <label for="">回忆标题</label>
        <input required="required" class="form-control" type="text" name="title">
      </div>
      <div class="form-group">

        <label for="">备注</label>
        <textarea required="required" class="form-control" rows="4" name="remark"></textarea> 
      </div>
           
      <div class="form-group">
        <label for="">详细地址</label>
        <select required="required" class="form-control" name="address"></select>
      </div>
      <div class="form-group">
        <label for="">去的时间</label>
        <input required="required" class="form-control" type="date" name="dateTime">
      </div> 
      <div class="form-group">
        <label for="">回忆照片</label>
        <div id="upload-test"></div>
      </div>                            
      <div class="form-group">

        <button type="button" class="button" id="point-form-submit">创建足迹</button>
      </div>
    </form>
  </div>
  <script>

    const USER = (()=>{
      let loginForm = document.querySelector("#login-form"),
          registerForm = document.querySelector("#register-form"),
          dom = document.querySelector("#login-form-container"),
          userDetail = {}
        return {
          refresh:()=>{
            return new Promise((resolve,reject)=>{
              api.getUserInfo()
              .then(res=>{
                  userDetail = res.data
                  USER.close()
                  resolve(userDetail)
              })
              .catch(e=>{
                if(e.status==-1){
                  USER.open()
                }
                reject(e)
              })            
              
            })
          },
          open:()=>{
            dom.classList.add("active")
          },
          close:()=>{
            loginForm.reset()
            dom.classList.remove("active")
          },
          switch:()=>{
            dom.classList.toggle("register")
          },
          info:(key)=>{
            if(key&&Object.prototype.hasOwnProperty.call(userDetail,key)) 
              return userDetail[key]
            return userDetail
          },
          register:()=>{
            if(!util.valid("#register-form")) return false

            let formData = new FormData(registerForm),
                params = {};
            formData.forEach((v,k)=>{
              params[k] = v
            })
            return api.register(params)
            .then(res=>{
                try{
                  window.localStorage.setItem("AUTH",res.data.token)
                }catch(e){}
                userDetail = res.data
                USER.refresh()
                USER.close()
            })             
          },
          login:()=>{
            if(!util.valid("#login-form")) return false

            let formData = new FormData(loginForm),
                params = {};
            formData.forEach((v,k)=>{
              params[k] = v
            })
            return api.login(params)
            .then(res=>{
              try{
                window.localStorage.setItem("AUTH",res.data.token)
              }catch(e){}
              userDetail = res.data
              USER.refresh()
              USER.close()
            }) 
            .catch(e=>{
                util.toast(e.data.msg,{
                  type:"error"
                })
            })             
          }
        }
    })()
    const USER_WIDGET = (()=>{
        let dom = document.querySelector("#user-widget-container")
        return{
          show:()=>{
            dom.classList.add("active")
          },
          hide:()=>{
            dom.classList.remove("active")
          }
        }
    })()
    const STATISTIC = (()=>{
        let dom = document.querySelector("#statistic"),
            detail = ``
        return {
          open:()=>{

          },
          refresh:()=>{
            api.getPointsStatistic()
            .then(res=>{
              let html = `
              <div class="flex">
                <div>
                  <h4>${USER.info('nickname')}</h4>  
                  <p>${USER.info('username')}</p>
                  <p>${new Date(USER.info('create_time')).format("yyyy-MM-dd")}加入</p>
                  
                </div>
                <div>
                  <button class="button button-mini">注销</button>
                </div>
              </div> 
              <div class="items" onclick="STATISTIC.open()">
                <span><b>${res.data.total||0}</b>个地点</span>  
                <span><b>${res.data.province.length}</b>个省</span>
                <span><b>${res.data.city.length}</b>个城市</span>
              </div>`
              dom.innerHTML = html
              USER_WIDGET.show()
            })
          }
        }
    })()
    const FORM = (()=>{
        let dom = document.querySelector("#point-form-container"),
            form = document.querySelector("#point-form");
        let upload = new Upload("#upload-test",{
          drag:true
        })
        return {
          open:() => {
            dom.classList.add("active")
          },
          close:() => {
            form.reset()
            upload.filePreviewReset()
            if(TEMP_MARKER){
              TEMP_MARKER.setMap(null)
            }
            dom.classList.remove("active")
          },

          submit:()=>{
            if(!util.valid("#point-form")) return false

            upload.upload()
            .then(images=>{
              let formData = new FormData(form),
                  params = {
                    images:images,
                    lnglat:contextMenuPositon,
                    city:contextMenuAddress.addressComponent.city,
                    province:contextMenuAddress.addressComponent.province
                  }
              formData.forEach((val,key)=>{
                params[key] = util.isString(val)?val.trim():val
              })
              api.createPoint(params)
              .then(res=>{
                createMarkers(res.data)
                STATISTIC.refresh()
                FORM.close()
              })            
            })
          }          
        }
    })();    
  </script>
  <script>
    document
    .querySelector("#point-form-submit")
    .addEventListener("click",(e)=>{
      FORM.submit()
    })
    document
    .querySelector("#login-form-submit")
    .addEventListener("click",(e)=>{
      USER.login()
      .then(res=>{
        window.initApplication()
      })
    }) 
    document
    .querySelector("#register-form-submit")
    .addEventListener("click",(e)=>{
      USER.register()
      .then(res=>{
        window.initApplication()
      })
    })       
 
    
  </script>
  <script>
    window.initApplication = ()=>{
      AMapLoader.load({
          "key": "42b77b78693257d472dc3c70311c3b1f",              // 申请好的Web端开发者Key，首次调用 load 时必填
          "version": "2.0",   // 指定要加载的 JSAPI 的版本，缺省时默认为 1.4.15
          "plugins": ["AMap.MarkerCluster","AMap.MouseTool","AMap.Geocoder","AMap.Geolocation"]           // 需要使用的的插件列表，如比例尺'AMap.Scale'等
      })
      .then((AMap)=>{
        window.AMap = AMap
        api.getPoints()
        .then(result=>{
          initMap(AMap,result.data.points)
        })
        STATISTIC.refresh()
      })
      .catch((e)=>{
         
      });      
    }


    USER.refresh()
    .then(()=>{
      initApplication()
    })  
    //window.map map实例
    //contextMenuPositon 全局变量，右键点击的位置和地址
    //contextMenuAddress
    window.TEMP_MARKER = null
    
    //点标
    window.MARKERS = []

    const createMarkerContent = (poi)=>{
      let index = MARKERS.length
      let container = util.createDom(
      `<div class='point-detail'><h3>${poi.title}</h3>
      <pre>${poi.remark}</pre>
      <p><small>${poi.province+'-'}${poi.city+'-'}${poi.address}</small></p>
      <p><small>${new Date(poi.dateTime).format("yyyy-MM-dd")}</small></p></div>`)
      if(poi.images&&poi.images.length){
        let images = util.createDom(`<div class="point-images"></div>`)
        for(p of poi.images){
          images.appendChild(util.createDom(`<div class="point-image"><img data-source="${p.url}" data-src="${util.resolvePreview(p.url,200)}" alt=""></div>`))
        }
        container.appendChild(images)
      }
      let button = util.createDom("<button class='point-remove button button-mini'>删除</button")
      button.addEventListener("click",()=>{
        removeMarker(poi,index)
      })
      container.appendChild(button)
      return container
    }    
    const removeMarker = (poi,markerIndex) =>{
      //需要增加删除确认
      api.removePoint(poi.id)
      .then(res=>{
        MARKERS[markerIndex-1].setMap(null)
        MAP.clearInfoWindow()
        STATISTIC.refresh()
      })
    }
    const markerClick = (e) => {
      var pointDetailWindow = new AMap.InfoWindow({
        closeWhenClickMap:true,
        offset: new AMap.Pixel(0, -30)
      })      
      pointDetailWindow.on("open",()=>{
        USER_WIDGET.hide()
      }) 
      pointDetailWindow.on("close",()=>{
        USER_WIDGET.show()
      })                
      let images = e.target.content.querySelectorAll(".point-images img")
      if(images&&images.length){
        for(image of images){
          if(!image.src){
            image.src = image.getAttribute("data-src")
          }
        }
      }
      pointDetailWindow.setContent(e.target.content);
      pointDetailWindow.open(MAP, e.target.getPosition());

    }      
    const createMarkers = (types)=>{
      const NormalIcon = new AMap.Icon({
          size: new AMap.Size(30, 30),
          image: './static/image/point.png',
          imageSize: new AMap.Size(30, 30),
      });      
      let realType = Object.prototype.toString.call(types)
      switch(realType){
        case "[object String]" :
          if(types=="temp"){
            try{
              TEMP_MARKER.setMap(null)
            }catch(e){}
            // console.log(contextMenuPositon)
            var marker = new AMap.Marker({
              imageSize: new AMap.Size(25, 34),
              position: contextMenuPositon,
              map: MAP,
              offset:new AMap.Pixel(-13, -30),
              icon:"./static/image/point-temp.png"

            });
            marker.on('click', ()=>{
              marker.setMap(null)
              FORM.close()
            });
            TEMP_MARKER = marker
            return TEMP_MARKER
          }
          break;
        case "[object Array]" :
          for (let i = 0; i < types.length; i++) {
              var marker = new AMap.Marker({
                  position: types[i]['lnglat'].split(","),
                  map: MAP,
                  offset:new AMap.Pixel(-13, -30),
                  icon:NormalIcon
              });
              MARKERS.push(marker)
              marker.content = createMarkerContent(types[i]);
              marker.on('click', markerClick);
          }        
          break;
        case "[object Object]" :
          var marker = new AMap.Marker({
              position: types['lnglat'].split(","),
              map: MAP,
              offset:new AMap.Pixel(-13, -30),  
              icon:NormalIcon
          });
          MARKERS.push(marker)
          marker.content = createMarkerContent(types);
          marker.on('click', markerClick);      
          break;          
      }
    

    }
    const initMap = (AMap,interestPoints)=>{
      window.MAP = new AMap.Map('map-container', {
          zoom:11,//级别
          zooms:[4,14],
          doubleClickZoom:false,
          rotateEnable:false
      })  
      //创建POI详情
   
      //创建经纬度解码器  
      const geocoder = new AMap.Geocoder({
        extensions:"all"
      })       
      const location = new AMap.Geolocation({
          enableHighAccuracy: true,//是否使用高精度定位，默认:true
          timeout: 10000         //超过10秒后停止定位，默认：5
      });
      createMarkers(interestPoints)
      //创建点标


      //创建地图右键菜单
      var contextMenu = new AMap.ContextMenu()
      //右键添加Marker标记
      contextMenu.addItem("添加标记", function (e) {
          var marker = createMarkers("temp")
          FORM.open()
          contextMenu.close()
      }, 0);    
      const createSelect = (options,dom)=>{
        let html = ``
        for(let opt of options){
          html+=`<option value="${opt.name}">${opt.name}</option>`
        }
        dom.innerHTML = html
      }
      //地图绑定鼠标右击事件——弹出右键菜单
      const handlePointCreate = (position)=>{
        geocoder.getAddress(position, function(status, result) {
          if (status === 'complete'&&result.regeocode) {
              var address = result.regeocode;
              window.contextMenuAddress = address
              createSelect(address.pois,document.querySelector("#point-form-container select[name='address']"))
              if(AMap.Browser.mobile){
                var marker = createMarkers("temp")
                FORM.open()               
              }else{
                contextMenu.open(MAP, position);
              }
          }else{
              util.toast('根据经纬度查询地址失败')
          }
        });           
      }
      if(AMap.Browser.mobile){
        let timer = []
        let t = 0
        MAP.on('touchstart', function(event) {
          // 清除默认行为
          // event.preventDefault();
          // 开启定时器
          if(timer) clearTimeout(timer);
          timer.push(setTimeout(() => {
            contextMenuPositon = event.lnglat
            handlePointCreate(contextMenuPositon)
          }, 700));
        });  
        MAP.on('touchend', function(event) {
          // 清除默认行为
          // event.preventDefault();
          // 清除定时器
          util.clearTimeout(timer);
        }); 
        MAP.on('touchmove', function(event) {
          // 清除默认行为
          // event.preventDefault();
          // 清除定时器
          util.clearTimeout(timer);
        }); 
        MAP.on('zoomstart', function(event) {
          // 清除默认行为
          // event.preventDefault();
          // 清除定时器
          util.clearTimeout(timer);
        });         
                              
      }else{
        MAP.on("rightclick", function (e) {
            contextMenuPositon = e.lnglat
            handlePointCreate(contextMenuPositon)
        });       
        
      }
      document
      .querySelector("#map-control-fullview")
      .addEventListener("click",(e)=>{
        MAP.setFitView();
      })
      document
      .querySelector("#map-control-location")
      .addEventListener("click",(e)=>{
        location.getCurrentPosition(function(status,result){
            if(status=='complete'){
              MAP.setZoomAndCenter(14,result.position)
            }else{
                
            }
        });
      })      
      MAP.setFitView();
    }
  </script>
</body>
</html>